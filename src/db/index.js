const path = require('path')
const Datastore = require('nedb')

const db = new Datastore({
  filename: path.join(__dirname, 'data', `_.db`)
})

db.loadDatabase()
db.persistence.setAutocompactionInterval(1000 * 60 * 1)

async function save({user, pass}) {
    return new Promise((resolve, reject) => {
        db.insert({user, pass}, (err) => {
            if (err) return reject(err)

            resolve({ success: true })
        })
    })
}

async function find({ query }) {
    return new Promise((resolve, reject) => {
        db.find(query, (err, result) => {
            if (err) return reject(err)

            resolve({ success: true, result })
        })
    })
}

async function findUsers({ query }) {
    return new Promise((resolve, reject) => {
        db.find(query, { pass: 0 }, (err, result) => {
            if (err) return reject(err)

            resolve({ success: true, result })
        })
    })
}

async function findOne(query) {
    return new Promise((resolve, reject) => {
        db.findOne(query, (err, result) => {
            if (err) return reject(err)

            resolve({ success: true, result })
        })
    })
}

module.exports = {
    find,
    findOne,
    findUsers,
    save
}